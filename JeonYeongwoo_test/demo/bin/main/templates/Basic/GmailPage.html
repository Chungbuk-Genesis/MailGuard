<!DOCTYPE html>
<html lang="ko">
<head>

	<title>Guest Index</title>

	<link type = "text/css" rel="stylesheet" href="/css/tempDesign.css">


	<!-- 부트스트랩 코드-->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <meta charset="UTF-8">
    
	<style>
	  body {
	    font-family: sans-serif;
	    padding: 0;
	    margin: 0;
	  }

	  .navbar {
	    margin-bottom: 0; /* 기본 20px 제거 */
	  }

	  /* 네비게이션과 콘텐츠 사이 간격 조정 */
	  .content {
	    margin-top: 0;
	    padding: 20px; /* 적당한 내부 여백 */
	  }

	  h1 {
	    margin-top: 0; /* h1 기본 상단 여백 제거 */
	  }
	</style>
</head>
<body>


	<div class="bg-1" >
		<nav class="navbar navbar-default"  >
		          <div class="container">
		          <div class= "navbar-header ">
		              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
		              <span class="icon-bar"></span>
		              <span class="icon-bar"></span>
		              <span class="icon-bar"></span>                        
		              </button>
		              <a class="navbar-brand" th:href="(${user != null}) ? @{/home} : @{/guest}">MailGuard</a>
		          </div>

				  <!-- 로그인 회원가입 버튼 -->
				            <div class="buttons navbar-right">
				  			  <ul class="nav navbar-nav" style="display: flex; align-items: center; height: 100%;">
								<li><a th:href="@{/gmail}">Gmail</a></li>
				  			    <li>
				  			      <a th:href = "@{/profile}">profile</a>
				  			    </li>
				  			    <li style="display: flex; align-items: center; margin-left: 10px;">
				  			      <p style="margin: 0;">logined as: <span th:text="${user.username}"></span></p>
				  			    </li>
				  			    <li style="margin-left: 10px;">
				  			      <a th:href="@{/logout}">Logout</a>
				  			    </li>
				  			  </ul>
				  			</div>

		          </div>
		      </nav>

	  </div>
	
	  <div class="container content">
	    <h1>Gmail API, Google OAuth login Test</h1>
	    <a id="login-btn" href="/login/google">1. Google 계정으로 로그인</a>
	    <br><br>
	    <button id="fetch-btn">2. 최신 메일 가져오기</button>

	    <div id="email-container" style="display:none;">
	        <h3 id="subject"></h3>
	        <p><strong>From:</strong> <span id="from"></span></p>
	        <hr>
	        <div id="body"></div>
	        <h4>첨부파일:</h4>
	        <ul id="attachments"></ul>
	    </div>
	  </div>

<p id="error"></p>

<script>
    document.getElementById('fetch-btn').addEventListener('click', async () => {
        const emailContainer = document.getElementById('email-container');
        const errorEl = document.getElementById('error');
        emailContainer.style.display = 'none';
        errorEl.textContent = '';

        try {
            const response = await fetch('/api/latest-email');
            if (response.status === 401) {
                errorEl.textContent = '로그인이 필요합니다. 먼저 로그인 버튼을 눌러주세요.';
                return;
            }
            if (!response.ok) {
                throw new Error('Failed to fetch email. Status: ' + response.status);
            }

            const email = await response.json();

            document.getElementById('subject').textContent = '제목: ' + email.subject;
            document.getElementById('from').textContent = email.from;
            document.getElementById('body').innerHTML = email.body;

            const attachmentsList = document.getElementById('attachments');
            attachmentsList.innerHTML = ''; // Clear previous list
            if (email.attachments && email.attachments.length > 0) {
                email.attachments.forEach(att => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = att.downloadUrl;
                    a.textContent = att.filename;
                    a.target = '_blank';
                    li.appendChild(a);
                    attachmentsList.appendChild(li);
                });
            } else {
                attachmentsList.innerHTML = '<li>첨부파일 없음</li>';
            }

            emailContainer.style.display = 'block';

        } catch (error) {
            console.error('Error fetching email:', error);
            errorEl.textContent = '메일을 가져오는 중 오류가 발생했습니다. 콘솔을 확인하세요.';
        }
    });
</script>
</body>
</html>
